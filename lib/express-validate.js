// Generated by CoffeeScript 1.3.3
var compactObject, validator, validatorWrapper, _;

_ = require('underscore');

validator = require('./validator');

compactObject = function(obj) {
  var i;
  for (i in obj) {
    if (obj.hasOwnProperty(i)) {
      if (!obj[i] && typeof obj[i] !== 'number') {
        delete obj[i];
      }
    }
  }
  return obj;
};

validatorWrapper = function(opts) {
  var rule, validatorMiddleware, _i, _len, _ref;
  opts = opts || {};
  _.defaults(opts, {
    exposeMixedParams: false,
    rules: [],
    asJSON: true
  });
  _ref = opts.rules;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    rule = _ref[_i];
    validator.addRule(rule.name, rule.rule);
  }
  validatorMiddleware = function(req, res, next) {
    req.defaults = function(defaults) {
      return req.p = _.defaults(req.p || {}, defaults);
    };
    req.validate = function(rules) {
      var params, result;
      params = _.extend(req.p || {}, compactObject(req.files), compactObject(req.params), compactObject(req.query), compactObject(req.body));
      if (opts.exposeMixedParams) {
        req.p = params;
      }
      result = validator.validate(params, rules);
      if (result.length) {
        if (opts.asJSON) {
          res.send({
            errors: result
          }, 400);
          return false;
        } else {
          res.send(result.join('\n'), 400);
          return false;
        }
      } else {
        return true;
      }
    };
    return next();
  };
  return validatorMiddleware;
};

module.exports = validatorWrapper;
